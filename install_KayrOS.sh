#!/bin/sh
# –í–∫–ª—é—á–∞–µ–º –ö–∏—Ä–∏–ª–ª–∏—Ü—É
# –ü–æ–¥–∞–≤–ª—è–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ —à—Ä–∏—Ñ—Ç–∞ –Ω–µ—Ç, —á—Ç–æ–±—ã —Å–∫—Ä–∏–ø—Ç –Ω–µ —É–ø–∞–ª
setfont cyr-sun16 >/dev/null 2>&1 || setfont ter-v16n >/dev/null 2>&1
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Gum
export GUM_CONFIRM_FOREGROUND="212"
export GUM_INPUT_CURSOR_FOREGROUND="212"

# ============================= 1. –°–ë–û–† –ò–ù–§–û–†–ú–ê–¶–ò–ò ================================
gum style --border double --margin "1 1" --padding "1 2" --border-foreground 212 "‚ú®‚ú®‚ú® –°–ª–∞–≤—è–Ω—Å–∫–∞—è —Å–∫–∞–∑–∫–∞ —Å–æ —Å—á–∞—Å—Ç–ª–∏–≤—ã–º –Ω–∞—á–∞–ª–æ–º. ‚ú®‚ú®‚ú®"
echo "–¢—ã –≤—Å—Ç—Ä–µ—á–∞–µ—à—å –º–∞–ª–µ–Ω—å–∫–æ–≥–æ —Å–≤–µ—Ç–ª–æ–≤–æ–ª–æ—Å–æ–≥–æ —ç–ª—å—Ñ–∞. üßùüèª "
echo ""
echo "üßùüèª '–ú–µ–Ω—è –∑–æ–≤—É—Ç –ö–∞–π—Ä–æ—Å. –Ø –ø—Ä–∏–Ω–µ—Å—É —Ç–µ–±–µ —É–¥–∞—á—É, –µ—Å–ª–∏ —Ç—ã –≤–æ–∑—å–º—ë—à—å –º–µ–Ω—è —Å —Å–æ–±–æ–π!'"
echo ""

# –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
echo "üßùüèª '–ö–∞–∫–æ–≤–æ —Ç–≤–æ—ë –∏–º—è, –≤–æ–∏–Ω? (—É–≤—ã, –ø–æ–∫–∞ —á—Ç–æ –ª–∞—Ç–∏–Ω–∏—Ü–µ–π)'"
NEW_USER=$(gum input --placeholder "user")
[ -z "$NEW_USER" ] && exit 1

# –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
echo "üßùüèª '–•–æ—Ä–æ—à–æ, $NEW_USER. –¢–∞–π–Ω–æ–µ —Å–ª–æ–≤–æ –∫–∞–∫–æ–µ –∑–∞–≥–∞–¥–∞–µ—à—å? (—É–≤—ã, –æ–ø—è—Ç—å)'"
NEW_PASS=$(gum input --password --placeholder "password")
[ -z "$NEW_PASS" ] && exit 1

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ö—ç—à –ø–∞—Ä–æ–ª—è
PASS_HASH=$(mkpasswd -m sha-512 "$NEW_PASS")

# –í—ã–±–æ—Ä –¥–∏—Å–∫–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
echo "üßùüèª '–í—ã–±–µ—Ä–∏ —Å—É–º–∫—É, –≤–µ—â–µ–π –≤ –∫–æ–µ–π –Ω–µ –∂–∞–ª–∫–æ: –≤—Å—ë –ø–æ–≤—ã–±—Ä–∞—Å—ã–≤–∞—é –¥–∞ —Å–∞–º –≤ –Ω–µ—ë –∑–∞–ª–µ–∑—É.'"
DISK=$(lsblk -d -n -o NAME,SIZE,MODEL | gum choose | awk '{print $1}')
[ -z "$DISK" ] && exit 1

gum confirm "üßùüèª '–í—ã–±—Ä–∞–ª /dev/$DISK? –Ø –∂ –Ω–µ —à—É—á—É, –≤—Å—ë –∏–∑ –Ω–µ—ë –≤—ã–±—Ä–æ—à—É. –£–≤–µ—Ä–µ–Ω?'" || exit 1

# ============================== 2. –†–ê–ó–ú–ï–¢–ö–ê –î–ò–°–ö–ê =================================
echo "–ö–∞–π—Ä–æ—Å —Ö–æ—Ö–æ—á–µ—Ç –∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏–∑ –Ω–µ—ë –≤–µ—â–∏. üéíüßπüßùüèª"
sleep 5

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å (nvme0n1p1 vs sda1)
PART_PREFIX="$DISK"
if echo "$DISK" | grep -q "[0-9]$"; then PART_PREFIX="${DISK}p"; fi

parted -s /dev/$DISK mklabel gpt

# –†–∞–∑–¥–µ–ª 1: Boot (ESP) - 512MB
parted -s /dev/$DISK mkpart ESP fat32 1MB 512MB
parted -s /dev/$DISK set 1 esp on

# –†–∞–∑–¥–µ–ª 2: –°–∏—Å—Ç–µ–º–∞ + –î–∞–Ω–Ω—ã–µ (Btrfs) 
parted -s /dev/$DISK mkpart root btrfs 512MB 100%

sleep 1

BOOT_PART="/dev/${PART_PREFIX}1"
MAIN_PART="/dev/${PART_PREFIX}2"

mkfs.fat -F 32 -n boot $BOOT_PART
# –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–∑–¥–µ–ª –≤ Btrfs
mkfs.btrfs -f -L main $MAIN_PART

# ====================== 3. –ú–û–ù–¢–ò–†–û–í–ê–ù–ò–ï –û–°–ù–û–í–ù–û–ì–û –î–ò–°–ö–ê ==========================
echo "–ö–∞–π—Ä–æ—Å –≥–æ—Ç–æ–≤–∏—Ç —Å–µ–±–µ —É–¥–æ–±–Ω–æ–µ –º–µ—Å—Ç–æ. üéíüßùüèª"
sleep 5

# –ú–æ–Ω—Ç–∏—Ä—É–µ–º –∫–æ—Ä–µ–Ω—å –≤—Ä–µ–º–µ–Ω–Ω–æ
mount $MAIN_PART /mnt

# –°–æ–∑–¥–∞–µ–º –ø–æ–¥—Ç–æ–º–∞ (–û–Ω–∏ –¥–µ–ª—è—Ç –æ–±—â–µ–µ –º–µ—Å—Ç–æ)
# @     -> –ö–æ—Ä–µ–Ω—å —Å–∏—Å—Ç–µ–º—ã (/)
# @home -> –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (/home)
btrfs subvolume create /mnt/@
btrfs subvolume create /mnt/@home

# –†–∞–∑–º–æ–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ–±—ã —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ
umount /mnt

# –û–ø—Ü–∏–∏: —Å–∂–∞—Ç–∏–µ zstd (—ç–∫–æ–Ω–æ–º–∏—Ç –º–µ—Å—Ç–æ –∏ —É—Å–∫–æ—Ä—è–µ—Ç SSD), noatime
OPTS="compress=zstd,noatime"

# –ú–æ–Ω—Ç–∏—Ä—É–µ–º –∫–æ—Ä–µ–Ω—å (/)
mount -o subvol=@,$OPTS $MAIN_PART /mnt

# –°–æ–∑–¥–∞–µ–º —Ç–æ—á–∫–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
mkdir -p /mnt/home
mkdir -p /mnt/boot

# –ú–æ–Ω—Ç–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —á–∞—Å—Ç–∏
mount -o subvol=@home,$OPTS $MAIN_PART /mnt/home

# –ú–æ–Ω—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫
mount $BOOT_PART /mnt/boot

# ==================== 4. –ú–û–ù–¢–ò–†–û–í–ê–ù–ò–ï –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–• –î–ò–°–ö–û–í ========================
echo "üßùüèª '–°–ª—É—à–∞–π, –∞ –¥–∞–≤–∞–π –∫–∞ —è –¥—Ä—É–≥–∏–µ —Ç–≤–æ–∏ —Å—É–º–∫–∏ –∫ —Å–µ–±–µ –ø–æ–±–ª–∏–∂–µ –ø–æ–¥–≤–∏–Ω—É.'"
sleep 5

# –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –¥–∏—Å–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –º—ã –≤—ã–±—Ä–∞–ª–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, nvme0n1 –∏–ª–∏ sda)
# –ß—Ç–æ–±—ã —Å–ª—É—á–∞–π–Ω–æ –Ω–µ —Ç—Ä–æ–≥–∞—Ç—å –µ–≥–æ —Ä–∞–∑–¥–µ–ª—ã
SYS_DISK_NAME=$(lsblk -no PKNAME "/dev/$DISK" | head -n1)
# –ï—Å–ª–∏ –≤–¥—Ä—É–≥ lsblk –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ—Ç—É (–±—ã–≤–∞–µ—Ç –Ω–∞ sda), –∑–Ω–∞—á–∏—Ç –¥–∏—Å–∫ —Å–∞–º —Å–µ–±–µ —Ä–æ–¥–∏—Ç–µ–ª—å
[ -z "$SYS_DISK_NAME" ] && SYS_DISK_NAME="$DISK"

# –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã –≤ —Å–∏—Å—Ç–µ–º–µ
# –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞: –ò–ú–Ø –¢–ò–ü –§–° –†–û–î–ò–¢–ï–õ–¨ –ú–ï–¢–ö–ê
lsblk -rn -o NAME,TYPE,FSTYPE,PKNAME,LABEL | while read -r DEV_NAME DEV_TYPE DEV_FSTYPE DEV_PARENT DEV_LABEL; do
    
    # 1. –§–∏–ª—å—Ç—Ä—ã: –ù–∞–º –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ —Ä–∞–∑–¥–µ–ª—ã (part), –Ω–µ –ø—É—Å—Ç—ã–µ –§–°, –Ω–µ swap, –Ω–µ iso
    [ "$DEV_TYPE" != "part" ] && continue
    [ -z "$DEV_FSTYPE" ] && continue
    [ "$DEV_FSTYPE" = "swap" ] && continue
    [ "$DEV_FSTYPE" = "iso9660" ] && continue
    
    # 2. –ì–ª–∞–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–∞–∑–¥–µ–ª—ã —Ç–æ–≥–æ –¥–∏—Å–∫–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–∞–≤–∏–º —Å–∏—Å—Ç–µ–º—É
    [ "$DEV_PARENT" = "$SYS_DISK_NAME" ] && continue

    # 3. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –∏–º—è –¥–ª—è –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    # –ï—Å–ª–∏ –µ—Å—Ç—å –º–µ—Ç–∫–∞ –¥–∏—Å–∫–∞ (Label) - –±–µ—Ä–µ–º –µ—ë, –∏–Ω–∞—á–µ –∏–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (sdb1)
    if [ -n "$DEV_LABEL" ]; then
        MOUNT_NAME="$DEV_LABEL"
    else
        MOUNT_NAME="$DEV_NAME"
    fi

    # 4. –¢–æ—á–∫–∞ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –±—É–¥—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π /media/–ò–º—è
    TARGET_MOUNT_POINT="/media/$MOUNT_NAME"
    
    # –†–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å —Å–µ–π—á–∞—Å (–≤ –∏–Ω—Å—Ç–∞–ª–ª—è—Ç–æ—Ä–µ)
    ACTUAL_PATH="/mnt$TARGET_MOUNT_POINT"

    # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –∏ –º–æ–Ω—Ç–∏—Ä—É–µ–º
    mkdir -p "$ACTUAL_PATH"
    mount "/dev/$DEV_NAME" "$ACTUAL_PATH"

    # 5. –î–µ–ª–∞–µ–º —Å–∏–º–ª–∏–Ω–∫ –≤ Home –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    # –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º —Å–∞–º—É –ø–∞–ø–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    mkdir -p "/mnt/home/$NEW_USER" 
    
    USER_LINK="/mnt/home/$NEW_USER/üíΩ $MOUNT_NAME"
    ln -s "$TARGET_MOUNT_POINT" "$USER_LINK"

    # –û—Ç–¥–∞–µ–º –ø—Ä–∞–≤–∞ –±—É–¥—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    chown 1000:100 "/mnt/home/$NEW_USER"
    chown 1000:100 "$ACTUAL_PATH"
    chown -h 1000:100 "$USER_LINK"
done

# ======================== 5. –ö–õ–û–ù–ò–†–û–í–ê–ù–ò–ï –ò –ù–ê–°–¢–†–û–ô–ö–ê =============================
echo "–ö–∞–π—Ä–æ—Å —Å–º–æ—Ç—Ä–∏—Ç —Å–≤–æ–∏ –∑–∞–ø–∏—Å–∏ –∏ –º—ã—Å–ª–µ–Ω–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –ø—Ä—ã–∂–æ–∫ –≤ —Å—É–º–∫—É. üéíüßùüèªüóíÔ∏è"
sleep 5

# –ü—É—Ç—å –¥–ª—è –∫–æ–Ω—Ñ–∏–≥–æ–≤
TARGET_DIR="/mnt/home/$NEW_USER/.config/nixos"
mkdir -p $TARGET_DIR
# –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å nix-–∫–æ–Ω—Ñ–∏–≥–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
NIX_SUBDIR="$TARGET_DIR/nix"

# –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
git clone https://github.com/shineofsilence/KayrOS.git $TARGET_DIR

# 1. –ú–µ–Ω—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–æ –≤—Å–µ—Ö —Ñ–∞–π–ª–∞—Ö
find $TARGET_DIR -name "*.nix" -exec sed -i "s/fighter-name/$NEW_USER/g" {} +

# 2. –ü—Ä–æ–ø–∏—Å—ã–≤–∞–µ–º –ø–∞—Ä–æ–ª—å
sed -i "/isNormalUser = true;/a \    initialHashedPassword = \"$PASS_HASH\";" $TARGET_DIR/configuration.nix

# 3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∂–µ–ª–µ–∑–∞
nixos-generate-config --root /mnt --show-hardware-config > $NIX_SUBDIR/hardware-configuration.nix
cd $TARGET_DIR
# 4. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —é–∑–µ—Ä–∞ –¥–ª—è Git
git config user.email "installer@kayros.local"
git config user.name "KayrOS Installer"
# 2. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª (–¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –≤ –∏–≥–Ω–æ—Ä–µ)
git add .
# 3. –î–µ–ª–∞–µ–º –∫–æ–º–º–∏—Ç.
git commit -m "chore: install KayrOS" --allow-empty
cd -
# ================================= 6. –£–°–¢–ê–ù–û–í–ö–ê ==================================
echo "–ö–∞–π—Ä–æ—Å –ø—Ä—ã–≥–∞–µ—Ç –≤ —Å—É–º–∫—É –∏ –∫–∞–∫–æ–µ —Ç–æ –≤—Ä–µ–º—è —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è –≤ –Ω–µ–π —Å —É–¥–æ–±—Å—Ç–≤–æ–º. üéí"
sleep 5

if lspci | grep -i "nvidia" > /dev/null; then
    FLAKE_NAME="KayrOS-Nvidia"
else
    FLAKE_NAME="KayrOS-Main"
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º —Ñ–ª–µ–π–∫–∞
nixos-install --flake "$TARGET_DIR#$FLAKE_NAME" --no-root-passwd

# –ß–∏–Ω–∏–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ –¥–æ–º–∞—à–Ω—é—é –ø–∞–ø–∫—É
chown -R 1000:100 /mnt/home/$NEW_USER

# =============================== 7. –ó–ê–í–ï–†–®–ï–ù–ò–ï ==================================
echo "–ö–∞–π—Ä–æ—Å –Ω–∞–∫–æ–Ω–µ—Ü —Ç–æ –æ–±—É—Å—Ç—Ä–æ–∏–ª—Å—è –∏ –µ—Ö–∏–¥–Ω–æ –≤—ã–≥–ª—è–¥—ã–≤–∞–µ—Ç. üßùüèªüéí"
echo ""
echo "üßùüèª '–ê —Ç—É—Ç —É–¥–æ–±–Ω–æ. –°–ª—É—à–∞–π, —Ç—ã –Ω–∞–≤–µ—Ä–Ω–æ–µ –∏—Å—Ç–æ–º–∏–ª—Å—è –æ–∂–∏–¥–∞—è. –î–∞–≤–∞–π-–∫–∞ —è —Ç–µ–±–µ –±—ã—Å—Ç—Ä—ã–π —Å–æ–Ω —É—Å—Ç—Ä–æ—é. –¢—ã –∂–µ –Ω–µ –ø—Ä–æ—Ç–∏–≤?'"

# –ò–ª–ª—é–∑–∏—è –≤—ã–±–æ—Ä–∞: –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –≤–µ–¥—É—Ç –∫ –æ–¥–Ω–æ–º—É –∏—Å—Ö–æ–¥—É
gum choose "–î–∞, –Ω–µ –ø—Ä–æ—Ç–∏–≤." "–ù–µ—Ç, –Ω–µ –ø—Ä–æ—Ç–∏–≤."

# –≠—Ñ—Ñ–µ–∫—Ç "–∫–æ–ª–¥–æ–≤—Å—Ç–≤–∞" –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π
gum spin --spinner dot --title "‚ú® –ù–∞—Å—ã–ª–∞—é —Å–æ–Ω..." -- sleep 3

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
reboot
